# Change these for your platform
CLANG=/usr/local/opt/llvm/bin/clang -emit-llvm -DFULL_UNROLL
LLVM_LINK=/usr/local/opt/llvm/bin/llvm-link
SAW=../../bin/saw
LSS=../../bin/lss

VER=1.0.2f
CFLAGS=-Iopenssl-${VER}/include \
       -Iopenssl-${VER}/crypto/aes \
       -I../../deps/llvm-verifier/sym-api

all: aes_ref.aig

openssl-${VER}.tar.gz:
	wget http://openssl.org/source/openssl-${VER}.tar.gz

openssl-${VER}/Configure:
	tar -xzvf openssl-${VER}.tar.gz

# Notes on "Configure":
#   * The "darwin64" choice is arbitrary. Other platforms should work.
#   * The "debug" portion avoids optimization. This is critical because
#     we currently don't support some instructions generated by the
#     optimizing build.
#   * The "no-asm" bit is crucial because we can't currently analyze asm.
openssl-${VER}/Makefile: openssl-${VER}/Configure
	(cd openssl-${VER} && CC="${CLANG}" ./Configure debug-darwin64-x86_64-cc no-asm)

openssl-${VER}/crypto/aes/aes_core.o: openssl-${VER}/Makefile
	make -C openssl-${VER}/crypto/aes

aes_wrap.bc: aes_wrap.c openssl-${VER}/crypto/aes/aes_core.o
	${CLANG} -c -emit-llvm ${CFLAGS} -o $@ $<

aes_all.bc: aes_wrap.bc openssl-${VER}/crypto/aes/aes_core.o
	${LLVM_LINK} -o $@ $^

aes_imp.aig: aes_all.bc
	@echo "The next step may take about a minute."
	${LSS} $<

aes_ref.aig: aes_imp.aig aes.saw
	${SAW} aes.saw

clean:
	rm -rf openssl-${VER}
	rm -f aes_wrap.bc aes_all.bc
	rm -f aes_imp.aig aes_ref.aig
